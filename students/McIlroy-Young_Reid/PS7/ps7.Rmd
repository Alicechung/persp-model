---
title: "Problem Set 7"
author: "Reid McIlroy-Young"
date: "February 27, 2017"
output: 
  html_document:
    toc: true
---

``` {r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE, warning = FALSE, error = FALSE)
set.seed(1234)
options(digits = 3)
library(tidyverse)
library(modelr)
library(broom)
library(gam)
```

# Biden

![](http://i.giphy.com/54Y2ZtR7BOuNa.gif)



``` {r, Q 1.1}
targetFile <- "data/biden.csv"
data <- read.csv(targetFile)

mse <- function(model, data) {
  x <- modelr:::residuals(model, data)
  mean(x ^ 2, na.rm = TRUE)
}


lin_Biden <- lm(biden ~ age + female + educ + dem + rep, data = data) 
lin_mse <- mse(lin_Biden, data)
```

The MSE for the whole set is `r lin_mse`.

``` {r, Q 1.2}
data_split <- resample_partition(data, c(test = 0.3, train = 0.7))
lin_Biden_train <- lm(biden ~ age + female + educ + dem + rep, data = data_split$train) 
lin_mse_val <- mse(lin_Biden_train, data_split$test)
```

The MSE for of the training set for the test set is `r lin_mse_val`. This is higher than when fitted again the whole set, suggesting the whole set fit led to over fitting.

``` {r, Q 1.3}

mseCal <- function(i) {
  #100 different splits
  if (i == 30) {
    i <- 30.1
  }
  r <- i / 100
  split <- resample_partition(data, c(test = r, train = 1 - r))
  lin_model <- lm(biden ~ age + female + educ + dem + rep, data = split$train)
  mse(lin_model, split$test)
}

mseLst <- lapply(1:100, mseCal)

plot(1:100, mseLst)
```

``` {r, Q 1.4}
loocv_data <- crossv_kfold(data, k = nrow(data))
loocv_models <- map(loocv_data$train, ~ lm(biden ~ age + female + educ + dem + rep, data = .))
loocv_mse <- map2_dbl(loocv_models, loocv_data$test, mse)
loocv_mean_mse <- mean(loocv_mse)
```

The mean MSE under leave-one-out is `r loocv_mean_mse`.

``` {r, Q 1.5}
tenFold_data <- crossv_kfold(data, k = 10)
tenFold_models <- map(tenFold_data$train, ~ lm(biden ~ age + female + educ + dem + rep, data = .))
tenFold_mse <- map2_dbl(tenFold_models, tenFold_data$test, mse)
tenFold_mean_mse <- mean(tenFold_mse)
```
The mean MSE under 10-fold CV is `r tenFold_mean_mse`.

``` {r, Q1.6}
biden_boot <- data %>%
  modelr::bootstrap(1000) %>%
  mutate(model = map(strap, ~ lm(biden ~ age + female + educ + dem + rep, data = .)),
         coef = map(model, tidy))

biden_boot %>%
  unnest(coef) %>%
  group_by(term) %>%
  summarize(est.boot = mean(estimate),
            se.boot = sd(estimate, na.rm = TRUE))
```
# College

``` {r, Q 2}
targetFile <- "data/college.csv"
data <- read.csv(targetFile)
```

``` {r, Q 2.phd}
lin_phd <- lm(Outstate ~ phD, data = data)
summary(lin_phd)
```

``` {r, Q 2.Grad.Rate}
lin_Grad.Rate <- lm(Outstate ~ Grad.Rate, data = data)
summary(lin_Grad.Rate)
```

``` {r, Q 2.Room.Board}
lin_Room.Board <- lm(Outstate ~ Room.Board, data = data)
summary(lin_Room.Board)
```

``` {r, Q 2.Room.Board}
lin_Room.Board <- lm(Outstate ~ Room.Board, data = data)
summary(lin_Room.Board)
```

``` {r, Q 2.nonlinear}
college_step <- glm(Outstate ~ cut(PhD, 5), data = data)
summary(college_step)
```

# GAM College

``` {r, Q 3.1}
targetFile <- "data/college.csv"
data <- read.csv(targetFile)

data_split <- resample_partition(data, c(test = 0.3, train = 0.7))
```


``` {r, Q 3.2}
lin_college <- lm(Outstate ~ Private + Room.Board + PhD + perc.alumni + Expend + Grad.Rate, data = data_split$train)
summary(lin_Room.Board)
```

``` {r, Q 3.3}
college_gam <- gam(Outstate ~ lo(perc.alumni) + lo(PhD) + lo(Expend) + lo(Grad.Rate) +Private + lo(Room.Board), data = data_split$train)

college_gam_terms <- preplot(college_gam, se = TRUE, rug = FALSE)

## age
data_frame(x = college_gam_terms$`lo(perc.alumni)`$x,
           y = college_gam_terms$`lo(perc.alumni)`$y,
           se.fit = college_gam_terms$`lo(perc.alumni)`$se.y) %>%
  mutate(y_low = y - 1.96 * se.fit,
         y_high = y + 1.96 * se.fit) %>%
  ggplot(aes(x, y)) +
  geom_line() +
  geom_line(aes(y = y_low), linetype = 2) +
  geom_line(aes(y = y_high), linetype = 2) +
  labs(title = "GAM of Biden feeling thermometer",
       subtitle = "Cubic spline",
       x = "Age",
       y = expression(f[1](age)))
```