---
title: "PS6"
author: "Cheng Yee Lim"
date: "17th February 2017"
output:
  github_document
---

```{r setup, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(broom)
library(modelr)
library(knitr)
library(caret)
library(pander)

theme_set(theme_bw())
```

```{r import, include = FALSE}
health <- read.csv("./data/mental_health.csv")
```
##Part 1: Modeling Voter Turnout 
### Describe the data (1 point)

####Plot a histogram of voter turnout. Make sure to give the graph a title and proper $x$ and $y$-axis labels. What is the unconditional probability of a given individual turning out to vote?
```{r}
health %>% 
  filter(!is.na(vote96)) %>%
  ggplot() + 
  geom_bar(aes(x = factor(vote96)), fill = "deepskyblue1") + 
  labs(x = "Voter Turnout", 
       y = "Count") + 
  scale_x_discrete(breaks = c(0,1), 
                   labels = c("Did not vote", "Voted"))
```
Generate a scatterplot of the relationship between mental health and observed voter turnout and overlay a linear smoothing line. What information does this tell us? What is problematic about this linear smoothing line?

```{r}

health %>%
  filter(!is.na(mhealth_sum) & !is.na(vote96)) %>%
  ggplot(aes(x = mhealth_sum, y = vote96)) + 
  geom_point() + 
  geom_smooth(method = "lm", color = "deepskyblue1") + 
  labs(x = "Mental Health Index", 
       y = "Voter Turnout")

```

### Basic model (3 points)

Estimate a logistic regression model of the relationship between mental health and voter turnout.

$$vote_i = \beta_0 + \beta_1 health_i$$
```{r}
m_voter <- glm(vote96 ~ mhealth_sum, data = health, family = binomial)
summary(m_voter)
```

####Is the relationship between mental health and voter turnout statistically significant?  

The relationship between mental health and voter turnout has a p-value of $3.13 * 10^{-13}$ is statistically significant at 1% significance level.  

####Interpret the estimated parameter for mental health in terms of log-odds.   
For every one-unit increase in an individual's mental health (where 0 is an individual with no depressed feelings, and 9 is an individual with the most severe depressed mood), we expect the log-odds of voting to decrease by 0.143.

####Generate a graph of the relationship between mental health and the log-odds of voter turnout.
```{r}
prob2odds <- function(x){
  x / (1 - x)
}

prob2logodds <- function(x){
  log(prob2odds(x))
}

health <- health %>%
  filter(!is.na(mhealth_sum) & mhealth_sum > 0) %>%
  add_predictions(m_voter) %>% 
  mutate(logodds = prob2logodds(pred), 
         odds = prob2odds(pred)) 

health %>% 
  ggplot(aes(x = mhealth_sum, y = logodds)) + 
  geom_line() + 
  labs(x = "Mental Health Index", 
       y = "Log-odds") 
```

####Interpret the estimated parameter for mental health in terms of odds. Generate a graph of the relationship between mental health and the odds of voter turnout.

The relationship between mental health and the odds of turning up to vote is 0.892.

```{r}
exp(-0.114)

health %>% 
  ggplot(aes(x = mhealth_sum, y = odds)) + 
  geom_line() + 
  labs(x = "Mental Health Index", 
       y = "Odds") 


```


####Interpret the estimated parameter for mental health in terms of probabilities. Generate a graph of the relationship between mental health and the probability of voter turnout. What is the first difference for an increase in the mental health index from 1 to 2? What about for 5 to 6?
The expected change in probability given an unit increase in the mental health index is -0.0273.  
The first difference for an increase in the mental health index from 1 to 2 is -0.0292.  
The first difference for an increase in the mental health index from 5 to 6 is -0.0348.  
```{r}
health %>% 
  ggplot(aes(x = mhealth_sum, y = pred)) + 
  geom_line() + 
  labs(x = "Mental Health Index", 
       y = "Predicted Probabilities") 

probability <- function(x, y){ 
  exp(1.13921 - 0.14348*y)/(1 + exp(1.13921 - 0.14348*y)) - exp(1.13921 - 0.14348*x)/(1+exp(1.13921 - 0.14348*x))
}
cat("First Difference from an increase in mental health index = ", probability(1,2))
cat("First Difference from an increase in mental health index = ", probability(5,6))

```


####Estimate the accuracy rate, proportional reduction in error (PRE), and the AUC for this model. Do you consider it to be a good model?
It is a decent model, it results in an improvement of 
```{r}
logit2prob <- function(x){
  exp(x) / (1 + exp(x))
} #logit2prob function

getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
} # determining best model 

mh_accuracy <- health %>%
  filter(!is.na(mhealth_sum & !is.na(vote96))) %>%
  add_predictions(m_voter) %>%
  mutate(pred2 = logit2prob(pred),
         pred2 = as.numeric(pred > .5))

mean(mh_accuracy$vote96 == mh_accuracy$pred2, na.rm = TRUE) #accuracy rate

# function to calculate PRE for a logistic regression model
PRE <- function(model){
  # get the actual values for y from the data
  y <- model$y
  
  # get the predicted values for y from the model
  y.hat <- round(model$fitted.values)
  
  # calculate the errors for the null model and your model
  E1 <- sum(y != median(y))
  E2 <- sum(y != y.hat)
  
  # calculate the proportional reduction in error
  PRE <- (E1 - E2) / E1
  return(PRE)
}

PRE(m_voter)

confusionMatrix(mh_accuracy$pred2, mh_accuracy$vote96)

```


### Multiple variable model (3 points)

Our GLM of voter turnout consists of three components:  

Firstly, we assume our outcome variable, voter turnout, is drawn from the binomial distribution with probability $\pi$, given the values of the predicator variables in the model. $\pi$ is the probability that, for any observation $i$, $Y$ will take on the particular value $Y_i$.  
In our model, $Y_i$ takes on the expected value of 1 with probability $\pi$ and 0 with probability $1-\pi$, so $\pi_i$ is the conditional probability of sampling a 1 in this group.  
  
Pr$(Y_i = y_i | \pi)$ = $\pi_i^{y_i}$ $(1 - \pi_i)^{1-y_i}$

```{r}
health %>% 
  filter(!is.na(vote96)) %>%
  ggplot() + 
  geom_histogram(aes(x = vote96, 
                     y = ..density..), 
                 fill = "deepskyblue1", 
                 na.rm = TRUE) + 
  labs(x = "Voter Turnout") + 
  scale_x_continuous(breaks = c(0,1), 
                   labels = c("Did not vote", "Voted")) #fix density

```

Secondly, since the probability of voter turnout may systematically vary to given known predictors, we incorporate that into the model with a linear predictor. The linear predictor is:  
$$g(\pi_i) \equiv \rho_i = \beta_0 + \beta_1health_i + \beta_2age_i + \beta_3educ_i + \beta_4black_i + \beta_5female_i + \beta_6married_i + \beta_7income_i + \epsilon_i$$ 

Thirdly, we use a logit link function to constrain the linear predictor to the [0,1] range. A link function, $g(\pi_i)$ $=$ $e^{\rho_i}$ / $(1+e^{\rho_i})$, transforms the expectation of the vector turnout to the linear predictor.


```{r}
voter <- glm(vote96 ~ mhealth_sum + age + educ + black + female + married + inc10, data = health, family = binomial)

summary(voter)
```

Interpret the results in paragraph format. This should include a discussion of your results as if you were reviewing them with fellow computational social scientists. Discuss the results using any or all of log-odds, odds, predicted probabilities, and first differences - choose what makes sense to you and provides the most value to the reader. Use graphs and tables as necessary to support your conclusions.

In this multivariate logistic regression model, the response variable is the binary voter turnout variable where 1 means the respondent voted and 0 means the respondent did not vote. The predictors include the mental health index, age, education, race (Black or not), gender (female or not), marital status (married or not), and family income (in \$10,000s). The regression results indicate that four of the coefficients are statistically significant; these coefficients are, respectively, -0.089102 for the mental health index, 0.042534 for age, 0.228686 for education and 0.069614 for income. These coefficients are given in terms of log-odds.

In terms of odds, hold other variables constant, a unit increase in the mental health index leads to an average change in the odds of voter turnout = 1 by a multiplicative factor of 0.9147523. Likewise, holding other variables constant, one year increase in age leads to an average change in the odds of voter turnout = 1 by a multiplicative factor of 1.043452. Again, holding other variables constant, one year increase in the number of years of formal education leads to an average change in the odds of voter turnout = 1 by a multiplicative factor of 1.256947. Finally, holding other variables constant, a unit increase in income leads to an average change in the odds of voter turnout = 1 by a multiplicative factor of 1.072094. In terms of predicted probabilities, these values correspond to, respectively, a multiplicative factor of 0.4777392 for each unit increase in the mental health index holding other variables constant, 0.510632 for age, 0.5569236 for educaiton, and 0.5173964 for income.

##Part 2: Modelling TV Consumption 

```{r}
gss <- read.csv("./data/gss2006.csv")
```

### Describe the data 
`health` contains a subset of the 2006 General Social Survey of 4510 American individuals in 2006. The response variable `tvhours` contains a count of TV hours watched per day for each individual in 2006. 

```{r}
gss %>% 
  filter(!is.na(tvhours)) %>%
  ggplot() + 
  geom_histogram(aes(x = tvhours), fill = "deepskyblue1", binwidth=2) + 
  labs(x = "Number of hours of TV watched per day", 
       y = "Count", 
       title = "Histogram of TV hours watched per day") 
```

###Multivariate Poisson Regression Model of Hours of TV Watched 
Firstly, we assume our outcome variable, number of hours of TV watched, is drawn from a poisson distribution, where Pr$(TVhours_i=k|\mu)$ = $(\mu^ke^{-\mu})$ / ${k!}$ .

In our model of predicting number of hours of TV watched per day, we include the following additional variables:  
1. `age` - Age (in years)   
2. `childs` - Number of children   
3. `educ` - Highest year of formal schooling completed  
4. `female` - 1 if female, 0 if male   
5. `hrsrelax` - Hours per day respondent has to relax  
6. `black` - 1 if respondent is black, 0 otherwise   
7. `social_connect` - Ordinal scale of social connectedness, with values low-moderate-high (0-1-2)   
8. `voted04` - 1 if respondent voted in the 2004 presidential election, 0 otherwise   
9. `xmovie` - 1 if respondent saw an X-rated movie in the last year, 0 otherwise   

Thus, the linear predictor of our model is:  
$$\eta_{i} = \beta_{0} + \beta_{1}age + \beta_{2}children + \beta_{3}educ + \beta_{4}female + \beta_{5}hrsrelax + \beta_{6}black$$ $$+ \beta_{7}social_connect + \beta_{8}voted04 + \beta_{9}xmovie + \epsilon_i$$

The link function for the poisson distribution is:  
$$\mu_{i} = \log(\eta_{i})$$

The results of the estimated multivariate poisson model is as follows:
```{r}
tv_hours <- glm(tvhours ~ age + childs + educ + female + hrsrelax + black + social_connect + voted04 + xmovie, data = gss, family = poisson)
summary(tv_hours)
```

From the regression results, we can identify that only `educ`, `hrsrelax`, and `black` are statistically significant at a 5% significance level. Since we used a multivariate poisson regression, the effects of variables will be calculated as exponential of the estimated parameters. 

```{r}
exp(coef(tv_hours))
```
####Education and Ethnicity 
For a one year increase in maximum years of schooling, the number of TV hours watched per day is expected to decrease by 0.973, given the rest of the variables in the model are held constant. The decline in hours of TV watched per day as maximum education years increase can also be shown in by the overall decreasing trend in the line graphs below. This trend is also valid across black and non-black ethnicities 

Furthermore, a black individual is, on average, expected to watch 1.54 more hours of TV per day than a non-black individual, given that the rest of the variables in the model are held constant. The differential between hours of TV watched by an average black and non-black individual can be visualized with the disparity between the blue and red lines. 
```{r}
gss %>%
  na.omit() %>%
  add_predictions(tv_hours) %>%
  group_by(educ, black) %>% 
  summarize(pred = mean(exp(pred))) %>%
  ggplot(aes(x = educ, y = pred)) +
  geom_line(aes(color = factor(black))) +
  labs(y = "Predicted Number of Hours of TV watched per day", 
       x = "Maximum Years of Education") + 
  scale_color_discrete(name = "Race", 
                     breaks = c(0,1), 
                     labels = c("Non-black", "Black"))
```

####Taste and Preferences
Unsurprisingly, according to the regression results, individuals who devote more time to relaxation per day are more likely to watch more hours of television. For an hour increase in hours the respondent has to relax, the number of TV hours watched per day is expected to increase by 1.048, given the rest of the variables in the model are held constant. 
```{r}
gss %>%
  na.omit() %>%
  add_predictions(tv_hours) %>%
  group_by(hrsrelax) %>% 
  summarize(pred = mean(exp(pred))) %>%
  ggplot(aes(x = hrsrelax, y = pred)) +
  geom_line() +
  labs(y = "Predicted Number of Hours of TV watched per day", 
       x = "Hours per day Respondent has to Relax")

```

####Over or under-dispersion 
The dispersion parameter is 1.116. While the dispersion parameter is larger than 1, it is rather close to 1 so over-dispersion does not appear to be a significant problem. 

```{r}
tv_disp <- glm(tvhours ~ age + childs + educ + female + hrsrelax + black + social_connect + voted04 + xmovie, data = gss, family = "quasipoisson")
summary(tv_disp)
```